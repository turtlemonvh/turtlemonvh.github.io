
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://turtlemonvh.github.io/theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/font-awesome/css/solid.css">












 

<meta name="author" content="turtlemonvh" />
<meta name="description" content="Python&#39;s multiprocessing library is pretty awesome, and it can make it much easier to build programs that exersize multiple cores in python. However, some libraries are known not to behave well with multiprocessing. You may be running into this problem if you see output like this from your program, in …" />
<meta name="keywords" content="python, multiprocessing, parallel">


  <meta property="og:site_name" content="Systems Doing"/>
  <meta property="og:title" content="Python multiprocessing and CoreFoundation libraries"/>
  <meta property="og:description" content="Python&#39;s multiprocessing library is pretty awesome, and it can make it much easier to build programs that exersize multiple cores in python. However, some libraries are known not to behave well with multiprocessing. You may be running into this problem if you see output like this from your program, in …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://turtlemonvh.github.io/python-multiprocessing-and-corefoundation-libraries.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2018-03-02 15:00:00-05:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://turtlemonvh.github.io/author/turtlemonvh.html">
  <meta property="article:section" content="Articles"/>
  <meta property="article:tag" content="python"/>
  <meta property="article:tag" content="multiprocessing"/>
  <meta property="article:tag" content="parallel"/>
  <meta property="og:image" content="//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120">

  <title>Systems Doing &ndash; Python multiprocessing and CoreFoundation libraries</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="https://turtlemonvh.github.io/">
      <img src="//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120" alt="Systems Doing" title="Systems Doing">
    </a>

    <h1>
      <a href="https://turtlemonvh.github.io/">Systems Doing</a>
    </h1>

    <p>Looking for beauty in the complex and the simple.</p>


    <nav>
      <ul class="list">


            <li>
              <a target="_self"
                 href="https://turtlemonvh.github.io/pages/home.html">
                Home
              </a>
            </li>
            <li>
              <a target="_self"
                 href="https://turtlemonvh.github.io/pages/projects.html">
                Projects
              </a>
            </li>

          <li>
            <a target="_self" href="https://about.me/turtlemonvh" >about.me</a>
          </li>
          <li>
            <a target="_self" href="https://www.dropbox.com/scl/fi/iqwp08l5mlb0gnv3kq5dm/TVH-Resume-2023-09-09.pdf?rlkey=4ixwskt3m9f4ceqcnnes2hrfn&raw=1" >resume</a>
          </li>
          <li>
            <a target="_self" href="http://turtle-philosophy.blogspot.com/" >old blog</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-twitter"
           href="https://twitter.com/turtlemonvh"
           target="_blank">
          <i class="fa-brands fa-twitter"></i>
        </a>
      </li>
      <li>
        <a class="sc-github"
           href="https://github.com/turtlemonvh"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-linkedin"
           href="https://www.linkedin.com/in/vanheetm"
           target="_blank">
          <i class="fa-brands fa-linkedin"></i>
        </a>
      </li>
      <li>
        <a class="sc-bitbucket"
           href="https://bitbucket.org/turtlemonvh/"
           target="_blank">
          <i class="fa-brands fa-bitbucket"></i>
        </a>
      </li>
      <li>
        <a class="sc-stack-overflow"
           href="http://stackoverflow.com/users/790075/turtlemonvh"
           target="_blank">
          <i class="fa-brands fa-stack-overflow"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="python-multiprocessing-and-corefoundation-libraries">Python multiprocessing and CoreFoundation libraries</h1>
    <p>
      Posted on Fri 02 March 2018 in <a href="https://turtlemonvh.github.io/category/articles.html">Articles</a>

    </p>
  </header>


  <div>
    <p>Python's <a href="https://docs.python.org/2/library/multiprocessing.html">multiprocessing library</a> is pretty awesome, and it can make it much easier to build programs that exersize multiple cores in python.  However, some libraries are known not to behave well with multiprocessing.  You may be running into this problem if you see output like this from your program, in addition to strange behavior like hanging code.</p>
<div class="highlight"><pre><span></span><code>The process has forked and you cannot use this CoreFoundation functionality safely. You MUST exec().
Break on __THE_PROCESS_HAS_FORKED_AND_YOU_CANNOT_USE_THIS_COREFOUNDATION_FUNCTIONALITY___YOU_MUST_EXEC__() to debug.
</code></pre></div>

<p>These issues come about because when the multiprocessing library creates a new process it does not call <code>exec</code> on forked processes, and because *nix OSes use "COW" (copy-on-write) forks of the parent process, there can be references shared between child and parent processes than can cause issues in some libraries.</p>
<p>For details, see:</p>
<ul>
<li>https://bugs.python.org/issue8713</li>
<li>https://groups.google.com/forum/#!topic/comp.lang.python/b2Ayc8bQzMQ</li>
</ul>
<p>To address this, Python 3 adds support for a <a href="https://docs.python.org/3/library/multiprocessing.html#contexts-and-start-methods">"spawn" option for starting processes</a>. This creates an entirely new python interpreter process.</p>
<blockquote>
<p>As an aside, this "spwan" behavior is actually the default behavior on Windows, which doesn't have COW forks.
This behavior can cause problems porting multiprocessing applications from *nix to Windows, since the COW forked processes in *nix OSes can sometimes have access to variables that the new-interpreter Windows processes cannot see.</p>
</blockquote>
<p>To address this problem in Python 2 code, we take a pretty simple approach.  Since the problem is shared references between parent and child processes, if the problematic libraries are never touched in the parent process (and only in child processes which don't fork additional children themselves), we shouldn't have problems with contention and reference collisions.</p>
<p>However, sometimes you need to get access to a library before you launch a pool of worker processes.  What do you do then?  Here is the pattern I adopted for a project recently:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span><span class="p">,</span> <span class="n">Queue</span>

<span class="k">def</span> <span class="nf">run_in_forked_process</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">wrapf</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="n">Process</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">wrapf</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">wrapper</span>
</code></pre></div></td></tr></table></div>

<p>The code looks a little complex, but it is just a <a href="https://www.python.org/dev/peps/pep-0318/">decorator</a> that you can add to a function that makes it safe to call in the main parent process.</p>
<p>What this decorator does is</p>
<ul>
<li>create a queue</li>
<li>run the function you want to execute in a new forked process, collecting the result on the queue</li>
<li>return the result it got back from the queue</li>
</ul>
<p>You can use it like this to make the function <code>my_function_using_corefoundation_libs</code> safe to run in the main process of a codebase that uses multiprocessing.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># Function definition</span>

<span class="nd">@run_in_forked_process</span>
<span class="k">def</span> <span class="nf">my_function_using_corefoundation_libs</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># Your code goes here</span>
    <span class="k">pass</span>

<span class="c1"># You can call your function as normal.</span>
<span class="c1"># It will just execute in a forked process instead of running in the main parent process.</span>

<span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">my_function_using_corefoundation_libs</span><span class="p">(</span><span class="s2">&quot;cat&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>

<p>This solution is not perfect.  It is not very efficient since it forks a whole process to run the function, and it won't handle exceptions very well.  But it does allow you to use some nice libraries with multiprocessing to get stuff done.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://turtlemonvh.github.io/tag/python.html">python</a>
      <a href="https://turtlemonvh.github.io/tag/multiprocessing.html">multiprocessing</a>
      <a href="https://turtlemonvh.github.io/tag/parallel.html">parallel</a>
    </p>
  </div>






<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'turtlemonvh-github-io';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy;  </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Systems Doing ",
  "url" : "https://turtlemonvh.github.io",
  "image": "//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120",
  "description": "Thoughts and writings"
}
</script>
</body>
</html>