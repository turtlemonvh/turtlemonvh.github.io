<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Systems Doing - python</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Systems Doing  <strong>Looking for beauty in the complex and the simple.</strong></a></h1>
                <nav><ul>
                    <li><a href="/pages/home.html">Home</a></li>
                    <li><a href="/pages/projects.html">Projects</a></li>
                    <li><a href="/category/articles.html">Articles</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/validating-biblescholar-scraping.html">Validating BibleScholar Scraping</a></h1>
<footer class="post-info">
        <abbr class="published" title="2017-01-02T14:00:00-05:00">
                Published: Mon 02 January 2017
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/turtlemonvh.html">turtlemonvh</a>
        </address>
<p>In <a href="/category/articles.html">Articles</a>.</p>
<p>tags: <a href="/tag/python.html">python</a> <a href="/tag/scraping.html">scraping</a> <a href="/tag/biblescholar.html">biblescholar</a> </p>
</footer><!-- /.post-info --><p>As with any data scraping tool, verifying correctness in BibleScholar's verse scraping utilities was pretty important.  After my first run through verses, here is what I was seeing between versions.  Note that this is before I added the ESV translation, which as you'll see below is the version with the largest differences to other translations.</p>
<div class="highlight"><pre><span></span>$ wc -l *.tsv
   <span class="m">30926</span> HCSB.tsv
   <span class="m">31102</span> KJV.tsv
   <span class="m">30852</span> NIV.tsv
   <span class="m">92880</span> total
</pre></div>


<p>Hmmm.  Something smells fishy here.  I know that some versions chose to leave out some verses or split verses in different places, but a difference of 250 verses between NIV and KJV (which I know to be similar translations) looked to be beyond a normal standard of error.  To fix this, I took the following steps.</p>
<hr />
<h2>Step 1: See where the differences are and fix bugs in the processing script</h2>
<p>All the verses were stored in tsv format (<code>&lt;translation&gt; &lt;book&gt; &lt;chapter&gt; &lt;verse #&gt; &lt;text&gt;</code>).  To make the analysis quick, I just extracted the <code>&lt;book&gt; &lt;chapter&gt; &lt;verse #&gt;</code> parts of the line into a file I named <code>.verses</code> do I could use <a href="http://man7.org/linux/man-pages/man1/diff.1.html">diff</a> to check for differences between what verses were included.  The commands to create these files and produce the diffs were as follows.</p>
<div class="highlight"><pre><span></span><span class="c1"># Generate files like &quot;&lt;book&gt; &lt;chapter&gt; &lt;verse&gt;&quot;</span>
cat NIV.tsv <span class="p">|</span> awk -F<span class="s2">&quot;\t&quot;</span> <span class="s1">&#39;{print $2, $3, $4}&#39;</span> &gt; NIV.verses
cat ESV.tsv <span class="p">|</span> awk -F<span class="s2">&quot;\t&quot;</span> <span class="s1">&#39;{print $2, $3, $4}&#39;</span> &gt; ESV.verses
cat HCSB.tsv <span class="p">|</span> awk -F<span class="s2">&quot;\t&quot;</span> <span class="s1">&#39;{print $2, $3, $4}&#39;</span> &gt; HCSB.verses

<span class="c1"># Diff 2 versions</span>
diff NIV.verses ESV.verses
</pre></div>


<p>My process I used was</p>
<ol>
<li>Find a verse that was missing in 1 version and present in another</li>
<li>Try to figure out why (could just be a difference in versions, but usually was a parsing error)</li>
<li>Fix the script responsible for extracting verses from a page</li>
<li>Re-create the TSV files</li>
<li>Return to step 1 and repeat until no more unexplained diffs appear.</li>
</ol>
<p>You can see the series of changes I made to the script in this <a href="https://github.com/turtlemonvh/biblescholar/commit/b21bed269c7ae4a31853a03f2ff00caba02c1e1a">git diff</a>.  In addition to fixing bugs that were causing some verses to be skipped, these changes also fix bugs where only parts of verses were included.</p>
<h2>Step 2: Validate remaining changes line by line</h2>
<p>After these changes, the line count difference was much better.  Note that KJV and NIV now have exactly the same verses.</p>
<div class="highlight"><pre><span></span>$ wc -l *.tsv
   <span class="m">31086</span> ESV.tsv
   <span class="m">31101</span> HCSB.tsv
   <span class="m">31102</span> KJV.tsv
   <span class="m">31102</span> NIV.tsv
  <span class="m">124391</span> total
</pre></div>


<p>However, there is we still see some differences when we look at individual diffs, and we want to make sure that all those changes are explained away as intended differences between the versions.</p>
<h3>Version comparison: NIV vs ESV</h3>
<div class="highlight"><pre><span></span>$ diff ESV.verses NIV.verses
<span class="o">(</span>... a bunch of things complaining about naming of <span class="s2">&quot;Song of Solomon&quot;</span> book<span class="o">)</span>
&gt; Matthew <span class="m">12</span> 47
23720a23722
&gt; Matthew <span class="m">17</span> 21
23736a23739
&gt; Matthew <span class="m">18</span> 11
23929a23933
&gt; Matthew <span class="m">23</span> 14
24475a24480
&gt; Mark <span class="m">7</span> <span class="m">16</span> 
24577a24583
&gt; Mark <span class="m">9</span> <span class="m">44</span> 
24578a24585
&gt; Mark <span class="m">9</span> <span class="m">46</span> 
24659a24667
&gt; Mark <span class="m">11</span> <span class="m">26</span> 
24846a24855
&gt; Mark <span class="m">15</span> <span class="m">28</span> 
25678a25688
&gt; Luke <span class="m">17</span> <span class="m">36</span> 
25942a25953
&gt; Luke <span class="m">23</span> <span class="m">17</span> 
26203a26215
&gt; John <span class="m">5</span> <span class="m">4</span> 
27201a27214
&gt; Acts <span class="m">8</span> 37
27463a27477
&gt; Acts <span class="m">15</span> 34
27762a27777
&gt; Acts <span class="m">24</span> 7
27913a27929
&gt; Acts <span class="m">28</span> 29
28344a28361
&gt; Romans <span class="m">16</span> 24
30657d30673
&lt; <span class="m">3</span> John <span class="m">1</span> 15
</pre></div>


<p>The first major difference was for <a href="https://en.wikipedia.org/wiki/Song_of_Songs">the book that comes after Ecclesiastes and before Isaiah</a>.  HCSB, ESV, and KJV all call it "Song of Solomon" but NIV (and Wikipedia, apparently) calls it "Song of Songs".  So when comparing with NIV, all verses in that chapter were marked as different.  But since I was just checking that all chapters and verses were included and not verifying that book names were the same, once I saw that the actual verses in that book were the same between all the other translations (e.g. ESV vs HCSB) I ignored those lines in the diff.</p>
<p>After that, I validated that every verse marked as present in the NIV and not present in the ESV is supposed to be missing.  I checked each one, and for each the ESV mentions that that verse was intentionally left out in a footnote.</p>
<p>There was only 1 case where a verse was present in the ESV and NOT in the NIV (<a href="https://www.biblegateway.com/passage/?search=3+John+1&amp;version=ESV">3 John 1:15</a>).  In that case the content is pretty much the same between the 2 translations.  They just chose to split the final verse of the book at a different place.</p>
<p>For the remainder of the comparisons, I use the NIV as the standard because it had more verses than the HCSB.</p>
<h3>Version comparison: NIV vs HCSB</h3>
<div class="highlight"><pre><span></span>$ diff NIV.verses HCSB.verses
27477d27476
&lt; Acts <span class="m">15</span> 34
29058d29056
&lt; <span class="m">2</span> Corinthians <span class="m">13</span> 14
30909a30908
&gt; Revelation <span class="m">12</span> 18
</pre></div>


<p>Checking out these diffs, we find:</p>
<ul>
<li>NIV and HCSB <em>both</em> leave out <a href="https://www.biblegateway.com/passage/?search=Acts+15&amp;version=NIV">Acts 15:34</a>, but NIV had a stub for the verse in the HTML.  The following is what the verses look like in the produced tsv files:</li>
</ul>
<div class="highlight"><pre><span></span>NIV Acts    15  33  After spending some time there, they were sent off by the believers with the blessing of peace  to return to those who had sent them.
NIV Acts    15  34  
NIV Acts    15  35  But Paul and Barnabas remained in Antioch, where they and many others taught and preached  the word of the Lord.
</pre></div>


<ul>
<li>HCSB leaves out <a href="https://www.biblegateway.com/passage/?search=2+Corinthians+13&amp;version=HCSB">2 Corinthians 13:14</a></li>
<li>NIV leaves out <a href="https://www.biblegateway.com/passage/?search=Revelation+12&amp;version=HCSB">Revelation 12:18</a></li>
</ul>
<p>So those look fine.</p>
<h3>Version comparison: NIV vs KJV</h3>
<p>Finally, we compare KJV to NIV.</p>
<div class="highlight"><pre><span></span>$ diff NIV.verses KJV.verses
<span class="o">(</span>... aside from the Song of Solomon naming difference, no difference<span class="o">)</span>
</pre></div>


<p>Nice!  The translations that originally started out with a 250 verse difference are now exactly the same.</p>
<h2>Step 3: Reindex the data</h2>
<p>Since I already created tooling for this, this was pretty easy.</p>
<div class="highlight"><pre><span></span># Back up existing database
$ mv verses.bleve verses.bleve.bk

# Make a new one
# Reindexing took &lt;30s per version, so after 2 minutes I had a brand new database
$ artifacts/biblescholar-darwin-amd64 index -d ../downloads/

# Test it out
$ bleve query verses.bleve &quot;peace I give to you&quot; -l 4
4491 matches, showing 1 through 4, took 13.866456ms
    1. John-14-27-HCSB (0.614247)
        Text
                â€œPeace I leave with you. My peace I give to you. I do not give to you as the world gives. Your heart must not be troubled or fearful.
    2. John-14-27-NIV (0.614247)
        Text
                Peace I leave with you; my peace I give you.  I do not give to you as the world gives. Do not let your hearts be troubled  and do not be afraid.
    3. John-14-27-ESV (0.601036)
        Text
                Peace I leave with you;  my peace I give to you. Not as the world gives do I give to you.  Let not your hearts be troubled, neither  let them be afraid.
    4. John-14-27-KJV (0.588642)
        Text
                Peace I leave with you, my peace I give unto you: not as the world giveth, give I unto you. Let not your heart be troubled, neither let it be afraid.
</pre></div>


<p>Not too bad.</p>
<h2>Step 4: Deploy updated application to Elastic Beanstalk App</h2>
<p>To do this, all I had to do was make sure that <code>verses.bleve</code> was in <a href="https://github.com/turtlemonvh/biblescholar/tree/master/search">the <code>search</code> directory</a> (the one with the Makefile) and run <code>make elbzip</code> to <a href="https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/applications-sourcebundle.html">create the application source bundle</a>.  Then I went to my app's Elastic BeanStalk Dashboard page, clicked the "Upload and Deploy" button, and uploaded the zip file.  Once that was uploaded I just selected the new release package and clicked "Deploy" from the drop down menu.  A few minutes later, everything was deployed.</p>
<p><img src="/images/updating-biblescholar-elb-dashboard.png" alt="Traffic Timer Plots" style="width: 100%; display: block; margin: 0 auto; border: 1px solid; padding: 3px;"/></p>
<p>Really, they make this stuff pretty simple.  I haven't even bothered using <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/eb-cli3.html">the command line tools</a> since the dashboard is so quick to work with.</p>
<hr />
<p>And with that BibleScholar is now running with a more accurate record of scripture.  I hope this description of the processes was helpful - let me know in the comments below or find me <a href="https://twitter.com/turtlemonvh">on twitter</a>.</p><p>There are <a href="/validating-biblescholar-scraping.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="https://www.ionic.com/blog/">Ionic blog</a></li>
                            <li><a href="http://turtle-philosophy.blogspot.com/">My old blog</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/turtlemonvh">twitter</a></li>
                            <li><a href="https://about.me/turtlemonvh">about.me</a></li>
                            <li><a href="https://github.com/turtlemonvh">github</a></li>
                            <li><a href="https://www.linkedin.com/in/vanheetm">linkedin</a></li>
                            <li><a href="https://bitbucket.org/turtlemonvh/">bitbucket</a></li>
                            <li><a href="http://stackoverflow.com/users/790075/turtlemonvh">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'turtlemonvh-github-io';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>