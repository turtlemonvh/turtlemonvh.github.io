<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Systems Doing - go</title>
        <link rel="stylesheet" href="/theme/css/main.css" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="/">Systems Doing  <strong>Looking for beauty in the complex and the simple.</strong></a></h1>
                <nav><ul>
                    <li><a href="/pages/home.html">Home</a></li>
                    <li><a href="/pages/projects.html">Projects</a></li>
                    <li><a href="/category/articles.html">Articles</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="/helpful-tips-for-testing-in-go.html">Helpful tips for testing in go</a></h1>
<footer class="post-info">
        <abbr class="published" title="2016-04-04T11:00:00-04:00">
                Published: Mon 04 April 2016
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="/author/turtlemonvh.html">turtlemonvh</a>
        </address>
<p>In <a href="/category/articles.html">Articles</a>.</p>
<p>tags: <a href="/tag/go.html">go</a> <a href="/tag/testing.html">testing</a> </p>
</footer><!-- /.post-info --><p>This post is a summary of some of the best resources I've found for explaining how to test <a href="https://golang.org/">golang</a> applications.</p>
<p>The first section of the article is a list of resources and what I learned from each one. </p>
<p>The second section is a high level summary of suggestions, as well as some techniques I've used to fill in gaps not directly addressed by other articles or talks.</p>
<p>I conclude with a few packages that may make life easier.</p>
<h1>Article summaries</h1>
<h2><a href="https://talks.golang.org/2014/testing.slide#1">Testing techniques</a></h2>
<blockquote>
<p>See: <a href="https://talks.golang.org/2014/testing.slide#1">Slides</a> | <a href="https://www.youtube.com/watch?v=ndmB0bj7eyw">Video</a></p>
</blockquote>
<p>This slidedeck is a great starting point for learning about testing. It provides a broad overview pretty quickly.</p>
<h3>Writing tests</h3>
<ul>
<li>Use <a href="http://dave.cheney.net/2013/06/09/writing-table-driven-tests-in-go">table driven tests</a><ul>
<li>Makes adding new test cases very easy.</li>
<li>There is even a tool to create these for you: <a href="https://github.com/cweill/gotests">gotests</a> (I haven't tried this yet)</li>
</ul>
</li>
<li>Use features of the <code>*testing.T</code> object<ul>
<li>logging, skipping, parallelizing</li>
</ul>
</li>
<li>Use the <a href="http://blog.golang.org/cover">built in coverage tool</a> to guide addition of new tests<ul>
<li><code>go test -cover</code></li>
</ul>
</li>
<li>Use <code>httptest</code> package.</li>
<li>Try out the race detection tools as part of your testing process.  Just run tests with <code>-race</code> flag.</li>
<li>Use go's concurrency primitives (locks, channels, waitgroups) to make concurrent tests more robust. Avoid <code>time.Sleep</code>.</li>
<li>Use static analysis.</li>
<li>If you have a complex package, use the fact that go lets <code>_test</code> files access unexported package details to test implementation.</li>
<li>If you want to enforce testing only the interface, you can use the package name <code>&lt;package&gt;_test</code> for your test files.<ul>
<li>Then they will only be able to access exported methods in the package under test.</li>
</ul>
</li>
<li>Avoid mocking and faking, and write good broad interfaces instead.</li>
</ul>
<h2><a href="https://speakerdeck.com/mitchellh/advanced-testing-with-go">Advanced Testung With Go</a></h2>
<p>This slidedeck from one of the founders of <a href="https://www.hashicorp.com/">Hashicorp</a> (the maker of great tools like Vagrant, Packer, Consul, and Terraform) has mostly simple suggestions, with a few neat ideas.</p>
<h3>Writing tests</h3>
<ul>
<li>Use test fixtures, taking advantage of the fact that <code>pwd</code> is set for you when running tests.</li>
<li>Use flags to generate output files used to compare to expected output in tests.<ul>
<li>Check these into version control so that any changes can be 'human checked'</li>
</ul>
</li>
<li>Write test helpers that accept a <code>*testing.T</code> object and fail<ul>
<li>Don't bother returning errors.</li>
</ul>
</li>
<li>Don't mock networking. Just use network connections directly.</li>
<li>Don't mock subprocesses. Just run them.<ul>
<li>If you need to fake it, make a simpler version of the subprocess (a different <code>cmd.Exec</code> object) and execute that.</li>
</ul>
</li>
<li>Try not to test internal api unless implementation is very complex.<ul>
<li>This ensures you are testing interface and not implementation.</li>
</ul>
</li>
<li><code>go test</code> is awesome. Avoid frameworks that don't use it.</li>
<li>When testing time related code, use a time multiplier instead of "fake time".</li>
<li>Avoid the built in parallel tests feature. Makes tests less reproducable.<ul>
<li>Instead, run multiple processes yourself if you want to test for concurrency bugs.</li>
</ul>
</li>
</ul>
<h3>Writing testable code</h3>
<ul>
<li>Parameterize methods and objects. <ul>
<li>Even things that are always the same value in practice could benefit from flexibility when testing.</li>
</ul>
</li>
<li>Minimize global state. This is very hard to test.</li>
<li>Getting the scope and size of packages right takes time. Huge and very small packages are not good.</li>
</ul>
<h2><a href="https://divan.github.io/posts/integration_testing/">Integration testing in Go using docker</a></h2>
<p>This article has some good suggestions on testing large complex applications with a lot of dependencies.</p>
<h3>Writing tests</h3>
<ul>
<li>docker is great for testing things like databases, queues, connections to other complex systems, etc.</li>
<li>use flags to limit what is included in tests<ul>
<li>to avoid running long test cases all the time</li>
<li><strong>NOTE</strong>: Others recommend <a href="https://golang.org/pkg/go/build/">build tags</a> as an alternate solution.</li>
</ul>
</li>
<li>account for multiple platforms (windows, osx vs linux) using <a href="https://docs.docker.com/machine/">docker-machine</a></li>
</ul>
<p>The package <a href="https://github.com/ory-am/dockertest">dockertest</a> formalizes a lot of these ideas.</p>
<h2><a href="https://peter.bourgon.org/go-in-production/#testing-and-validation">Go in production: Testing and validation</a></h2>
<p>This article from an engineer at SoundCloud has a lot of great suggestions. Testing and validation is just 1 part.</p>
<h3>Writing tests</h3>
<ul>
<li>use <code>reflect.DeepEqual</code> often to test for equality</li>
<li>use build tags to specify what files should be included in tests<ul>
<li>this makes it easy to selectively run longer tests as part of integration testing while keeping unit tests fast</li>
</ul>
</li>
<li>use flags for things like service addresses and use these in your tests<ul>
<li>essentially these are package level global variables, but at least they are easy to modify</li>
</ul>
</li>
</ul>
<h2><a href="https://splice.com/blog/lesser-known-features-go-test/">Lesser known features of go test</a></h2>
<p>This post by engineers at <a href="https://splice.com/">splice</a> (a music creation and collaboration service) outlines a lot of nice built in features of <code>go test</code>.</p>
<h3>Writing tests</h3>
<ul>
<li>use the build in <code>-short</code> and <code>-v</code> flags and the associated <code>testing.Short()</code> and <code>testing.Verbose()</code> conditionals<ul>
<li>use these to skip portions of tests </li>
</ul>
</li>
<li>use the <code>-timeout</code> flag to fail tests that take more than a given amt of time</li>
<li>use the <code>-run</code> flag to run a specific test (e.g. <code>go test -run TestTheThing</code>)</li>
<li>the <code>&lt;package&gt;_test</code> package name for tests can be helpful in breaking import cycles</li>
<li>use the <code>-parallel</code> command line flag to control the parallelism of tests</li>
<li>send multiple package names to <code>go test</code> to build and run tests for each package in a separate process (e.g. <code>go test p1 p2 p3</code>)<ul>
<li>this happens naturally when you run <code>go test ./...</code></li>
<li>can use <code>-p</code> flag to control parallelism when running tests this way</li>
</ul>
</li>
<li>to get tests to run with multiple processors, do either of:<ul>
<li>adjust <code>GOMAXPROCS</code> to &gt;1</li>
<li>use <code>-cpu</code> flag to specify the cpu counts you want to run with (e.g. <code>go test -cpu 1,2 ./...</code> will run all tests 2X, once with 1 cpu and once with 2 cpus)</li>
</ul>
</li>
</ul>
<h1>Summary of recommendations</h1>
<p>Some things were repeated over and over</p>
<ul>
<li>Use table driven tests</li>
<li>Use the built in testing tool as much as possible, avoiding packages that break it</li>
<li>Avoid mocking, actually executing code or using interfaces instead</li>
</ul>
<p>There are also a few things that I picked up that either weren't mentioned elsewhere or just have been helpful to remember.</p>
<ul>
<li>For open source projects, <a href="https://docs.travis-ci.com/user/languages/go">integration with travis CI</a> is very simple</li>
<li>To run all tests in a project<ul>
<li><code>go test ./...</code></li>
</ul>
</li>
</ul>
<p>And there are a few things I still need to figure out.</p>
<ul>
<li>How to share test utilities<ul>
<li>Unfortunately functions and objects in <code>*_test.go</code> files are not available for import by other tests</li>
<li>Right now I am adding a <code>&lt;package&gt;_test_utilities.go</code> file to packages that provides utilities I can use in other tests</li>
<li>This seems to be a common pattern, even seen in the standard library<ul>
<li>The upside is we access to package internals</li>
<li>The downside is we include test-specific code as part of the public interface of our package</li>
</ul>
</li>
<li>Some other questions about this<ul>
<li><a href="http://grokbase.com/t/gg/golang-nuts/136t4f5een/go-nuts-importing-from-test-packages">grokbase | Importing from test packages?</a></li>
<li><a href="http://stackoverflow.com/questions/31794141/can-i-create-shared-test-utilities-in-go">StackOverflow | Can I create shared test utilities in go?</a></li>
</ul>
</li>
</ul>
</li>
<li>How to check equality for json strings<ul>
<li>I wrote <a href="https://gist.github.com/turtlemonvh/e4f7404e28387fadb8ad275a99596f67">this utility</a> which loads in json then compares using <code>reflect</code>, but I don't love it.</li>
</ul>
</li>
</ul>
<h1>Useful packages</h1>
<h2><a href="https://github.com/stretchr/testify">testify</a></h2>
<p><a href="https://github.com/stretchr/testify">testify</a> is the only testing-specific package I use regularly.  It plays nice with the standard <a href="https://golang.org/pkg/testing/">testing</a> package and adds lots of assertions that make declaring tests less verbose. 
I don't use any of the mocking features.
Even this package has dropped http testing utilities for the standard library's <a href="https://golang.org/pkg/net/http/httptest/">httptest package</a>.</p>
<h2><a href="https://github.com/alecthomas/gometalinter">gometalinter</a></h2>
<p>I'm just starting to use this package.  It is a wrapper around a bunch of static analysis tools.
If this becomes a regular part of my workflow, I'll loop back around and write about how I use it.</p>
<h2><a href="https://github.com/spf13/viper">viper</a></h2>
<p>They're not testing specific at all, but I use <a href="https://github.com/spf13/viper">viper</a> and <a href="https://github.com/spf13/cobra">cobra</a> for most of my new go projects, and those packages make working with editable global state very easy.  These makes testing variable configuration very easy.</p>
<h1>The end</h1>
<p>I didn't address <a href="http://blog.golang.org/profiling-go-programs">performance profiling</a> or <a href="http://dave.cheney.net/2013/06/30/how-to-write-benchmarks-in-go">benchmarking</a>, but may do so in a future post.  I will also probably be adding to this post over the next couple weeks.</p>
<p>Still, I hope that was helpful as it was.  If you think I missed something obvious, please <a href="https://twitter.com/turtlemonvh">let me know</a>.</p><p>There are <a href="/helpful-tips-for-testing-in-go.html#disqus_thread">comments</a>.</p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>blogroll</h2>
                        <ul>
                            <li><a href="https://www.ionic.com/blog/">Ionic blog</a></li>
                            <li><a href="http://turtle-philosophy.blogspot.com/">My old blog</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>

                            <li><a href="https://twitter.com/turtlemonvh">twitter</a></li>
                            <li><a href="https://about.me/turtlemonvh">about.me</a></li>
                            <li><a href="https://github.com/turtlemonvh">github</a></li>
                            <li><a href="https://www.linkedin.com/in/vanheetm">linkedin</a></li>
                            <li><a href="https://bitbucket.org/turtlemonvh/">bitbucket</a></li>
                            <li><a href="http://stackoverflow.com/users/790075/turtlemonvh">stackoverflow</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

<script type="text/javascript">
    var disqus_shortname = 'turtlemonvh-github-io';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'https://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
</body>
</html>