
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="http://turtlemonvh.github.io/theme/stylesheet/style.min.css">

  <link rel="stylesheet" type="text/css" href="http://turtlemonvh.github.io/theme/pygments/github.min.css">
  <link rel="stylesheet" type="text/css" href="http://turtlemonvh.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="http://turtlemonvh.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="http://turtlemonvh.github.io/theme/font-awesome/css/solid.css">







<meta name="author" content="turtlemonvh" />
<meta name="description" content="The Problem As part of our analytics solution at Ionic, my team was working on a system to push files to customer owned endpoints. We wanted to do a quick validation that pushed to a server outside our network was working. We already had a test environment running locally with …" />
<meta name="keywords" content="kubernetes, docker, sftp">

<meta property="og:site_name" content="Systems Doing"/>
<meta property="og:title" content="Quick and dirty kubernetes"/>
<meta property="og:description" content="The Problem As part of our analytics solution at Ionic, my team was working on a system to push files to customer owned endpoints. We wanted to do a quick validation that pushed to a server outside our network was working. We already had a test environment running locally with …"/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://turtlemonvh.github.io/quick-and-dirty-kubernetes.html"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2017-10-27 18:47:00-04:00"/>
<meta property="article:modified_time" content=""/>
<meta property="article:author" content="http://turtlemonvh.github.io/author/turtlemonvh.html">
<meta property="article:section" content="Articles"/>
<meta property="article:tag" content="kubernetes"/>
<meta property="article:tag" content="docker"/>
<meta property="article:tag" content="sftp"/>
<meta property="og:image" content="//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120">

  <title>Systems Doing &ndash; Quick and dirty kubernetes</title>

</head>
<body>
  <aside>
    <div>
      <a href="http://turtlemonvh.github.io">
        <img src="//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120" alt="Systems Doing" title="Systems Doing">
      </a>
      <h1><a href="http://turtlemonvh.github.io">Systems Doing</a></h1>

<p>Looking for beauty in the complex and the simple.</p>
      <nav>
        <ul class="list">
          <li><a href="http://turtlemonvh.github.io/pages/home.html">Home</a></li>
          <li><a href="http://turtlemonvh.github.io/pages/projects.html">Projects</a></li>

          <li><a href="https://www.ionic.com/blog/" target="_blank">Ionic blog</a></li>
          <li><a href="http://turtle-philosophy.blogspot.com/" target="_blank">My old blog</a></li>
          <li><a href="https://about.me/turtlemonvh" target="_blank">about.me</a></li>
        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-twitter" href="https://twitter.com/turtlemonvh" target="_blank">
            <i class="fab fa-twitter">
            </i>
          </a></li>
          <li>
            <a  class="sc-github" href="https://github.com/turtlemonvh" target="_blank">
            <i class="fab fa-github">
            </i>
          </a></li>
          <li>
            <a  class="sc-linkedin" href="https://www.linkedin.com/in/vanheetm" target="_blank">
            <i class="fab fa-linkedin">
            </i>
          </a></li>
          <li>
            <a  class="sc-bitbucket" href="https://bitbucket.org/turtlemonvh/" target="_blank">
            <i class="fab fa-bitbucket">
            </i>
          </a></li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/790075/turtlemonvh" target="_blank">
            <i class="fab fa-stack-overflow">
            </i>
          </a></li>
      </ul>
    </div>


  </aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="quick-and-dirty-kubernetes">Quick and dirty kubernetes</h1>
    <p>
          Posted on Fri 27 October 2017 in <a href="http://turtlemonvh.github.io/category/articles.html">Articles</a>


    </p>
  </header>


  <div>
    <h1>The Problem</h1>
<p>As part of our analytics solution at Ionic, my team was working on a system to push files to customer owned endpoints.  We wanted to do a quick validation that pushed to a server outside our network was working.</p>
<p>We already had a test environment running locally with <a href="https://github.com/atmoz/sftp">an sftp docker image</a>, and since I didn't already have a public server sitting around for running an sftp server, I decided this was a great opportunity to play around with <a href="https://cloud.google.com/container-engine/">Google Cloud's Container service</a> and <a href="https://kubernetes.io/">Kubernetes</a> to spin up a quick and dirty sftp server to try to push data to.</p>
<h1>Web console to cli</h1>
<p>I started out trying to do everything through the web console.  I went to the Container Engine section of the test project I already had set up in GCP and created a test cluster named <code>sftp</code>.  I created it with size 1 (only 1 backing host) to keep the cost low, and because having a single sftp server is easier to reason about for testing purposes (i.e. there is only 1 place your data will be).  There are a lot of other options for a cluster, but I kept most of them set to their defaults.</p>
<p>From there it wasn't very clear how to run a container from the web ui, so I had to dig into command line tools.  With those, I started here: <a href="https://cloud.google.com/sdk/docs/quickstart-linux">https://cloud.google.com/sdk/docs/quickstart-linux</a>.  I installed the sdk into a Centos 7 vagrant box that my team uses for most of our development.</p>
<div class="highlight"><pre><span></span># Download, extract, install, init
wget https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-177.0.0-linux-x86_64.tar.gz
tar xzvf google-cloud-sdk-177.0.0-linux-x86_64.tar.gz
./google-cloud-sdk/install.sh

# Move it to a better place than `/tmp` since I&#39;m going to be sticking this on my path
sudo mv google-cloud-sdk /opt/
export PATH=$PATH:/opt/google-cloud-sdk/bin

# Init
gcloud init

# Get credentials for the cluster
# This is pretty cool - it gives you a url to visit in your browser, redirects you to an Oauth authorization page, and finally gives you a token to paste back into your console.
# I replaced by project id with XXXX.
gcloud container clusters get-credentials sftp --zone us-central1-a --project ionictest-XXXX
</pre></div>


<h1>The first hiccup: install path</h1>
<p>This was all working pretty well, but then I ran into issues when I ran <code>gcloud components install kubectl</code>.  There were permission issues because <code>gcloud</code> tries to write a scratch directory at the same level as its installation directory (i.e. in <code>/opt</code> instead of in <code>/opt/google-cloud-sdk</code>.)  This was a strange choice, since it meant that I had to nest the installation another level deeper.</p>
<div class="highlight"><pre><span></span># Nesting nesting
sudo mkdir -p /opt/google
sudo chown -R vagrant:vagrant /opt/google
sudo mv /opt/google-cloud-sdk /opt/google

# Fix path
# Really this was more manual since I removed the old bin path and also updated ~/.bashrc
export PATH=$PATH:/opt/google/google-cloud-sdk/bin

# Now installation works
gcloud components install kubectl
</pre></div>


<p>At this point the path was bjorked.  When I tried to run <code>kubectl run</code> I got this mysterious error</p>
<div class="highlight"><pre><span></span><span class="n">error</span><span class="o">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">discover</span> <span class="n">supported</span> <span class="n">resources</span><span class="o">:</span> <span class="n">Get</span> <span class="n">https</span><span class="o">://</span><span class="n">XX</span><span class="o">.</span><span class="na">XX</span><span class="o">.</span><span class="na">XX</span><span class="o">.</span><span class="na">XX</span><span class="sr">/api: error executing access token command &quot;/opt/google-cloud-sdk/bin/gcloud config config-helper --format=json&quot;: err=fork/exec /opt/google-cloud-sdk/bin/g</span><span class="n">cloud</span><span class="o">:</span> <span class="n">no</span> <span class="n">such</span> <span class="n">file</span> <span class="n">or</span> <span class="n">directory</span> <span class="n">output</span><span class="o">=</span>
</pre></div>


<p>Notice the path is pointing to the old installation location.  I reset my PATH, logged out of the vm and logged back in, and re-ran <code>gcloud components install kubectl</code>, none of which worked.  Then I re-ran the <code>gcloud container clusters get-credentials</code>, which worked.  So I guess the path to the binary is stored somewhere in the credentials config?  I'm not sure.  This article is called "quick and dirty" for a reason.</p>
<p>Now to launch containers.</p>
<div class="highlight"><pre><span></span>kubectl run sftp --image=atmoz/sftp --port 22
kubectl expose deployment sftp --type=LoadBalancer --port 22 --target-port 22
</pre></div>


<p>Alright - we're running!</p>
<h1>The second hiccup: container arguments</h1>
<p>Well, almost.  When I checked the Google Container Engine dashboard I saw the the containers has the status <code>CrashLoopBackoff</code>, which didn't sound good.  I dug into the kubectl cli a bit more and found some useful commands.</p>
<div class="highlight"><pre><span></span># List items
kubectl get pods
kubectl get services
kubectl get deployments

# Clear out items (very helpful when testing)
kubectl delete pod sftp-2557270963-pc8q8
kubectl delete service sftp
kubectl delete deployment sftp
</pre></div>


<p>I leave it to the kubernetes docs to define what the things are in depth, but in brief the pods are containers and services and deployments are higher level management concepts to work with containers.  For the point of this article the most important take aways are this</p>
<ul>
<li>If you delete a pod, it will come back.</li>
<li>If you want to stop something from running and start over, delete the service and the deployment. The pods will go away with those.</li>
</ul>
<p>So - now we have pods deployed, but crashing.  The missing link here was the difference between kubernetes commands and docker entrypoints.</p>
<div class="highlight"><pre><span></span># What our docker compose looks like for running locally
# Use the default entrypoint, override the command
version: &#39;2&#39;
services:
  sftp:
    image: atmoz/sftp
    command: username:password:::export

# What we had to do in kubectl
# Use the default command, send an argument
kubectl run sftp --image=atmoz/sftp --port=22 -- &quot;username:password:::export&quot;
</pre></div>


<h1>Final steps and success</h1>
<p>Once that was updated, I just had to expose the services again (<code>kubectl expose deployment sftp --type=LoadBalancer --port 22 --target-port 22</code>).  I also had to wait for the service to come up.  You can check this via <code>kubectl get services</code> and waiting until the <code>EXTERNAL-IP</code> field changes from "pending" to a real ip.  Once that was ready, and I could sftp in!</p>
<div class="highlight"><pre><span></span>[vagrant@localhost ~]$ sftp username@XX.XX.XX.XX
username@XX.XX.XX.XX&#39;s password:
Connected to XX.XX.XX.XX.
sftp&gt; ls export/
export/testfile.json
</pre></div>


<p>I hope that was helpful.  I have been using docker daily for a few years now, but this is my first time playing with kubernetes.  If I did something stupid, let me know!  You can find me <a href="https://twitter.com/turtlemonvh">on twitter</a>.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="http://turtlemonvh.github.io/tag/kubernetes.html">kubernetes</a>
      <a href="http://turtlemonvh.github.io/tag/docker.html">docker</a>
      <a href="http://turtlemonvh.github.io/tag/sftp.html">sftp</a>
    </p>
  </div>





<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'turtlemonvh-github-io';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
        Please enable JavaScript to view comments.

</noscript>
<!-- End Disqus -->
</article>

    <footer>
<p>&copy;  </p>
<p>    Powered by <a href="http://getpelican.com" target="_blank">Pelican</a> - <a href="https://github.com/alexandrevicenzi/flex" target="_blank">Flex</a> theme by <a href="http://alexandrevicenzi.com" target="_blank">Alexandre Vicenzi</a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Systems Doing ",
  "url" : "http://turtlemonvh.github.io",
  "image": "//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120",
  "description": "Thoughts and writings"
}
</script>

</body>
</html>