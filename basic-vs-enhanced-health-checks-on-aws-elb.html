
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/stylesheet/style.min.css">


    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
          href="https://turtlemonvh.github.io/theme/pygments/github.min.css">



  <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="https://turtlemonvh.github.io/theme/font-awesome/css/solid.css">












 

<meta name="author" content="turtlemonvh" />
<meta name="description" content="The Problem Yesterday I started getting a lot of emails from Amazon saying that there were issues with the ELB application that runs my Alexa App. Something fishy with #ELB on @awscloud over the last 24 hours... (no changes to application and load is stable and low) pic.twitter.com …" />
<meta name="keywords" content="alexa, elasticbeanstalk, aws, biblescholar">


  <meta property="og:site_name" content="Systems Doing"/>
  <meta property="og:title" content="Basic vs Enhanced Health Checks on AWS ELB"/>
  <meta property="og:description" content="The Problem Yesterday I started getting a lot of emails from Amazon saying that there were issues with the ELB application that runs my Alexa App. Something fishy with #ELB on @awscloud over the last 24 hours... (no changes to application and load is stable and low) pic.twitter.com …"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="https://turtlemonvh.github.io/basic-vs-enhanced-health-checks-on-aws-elb.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2017-06-29 09:00:00-04:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="https://turtlemonvh.github.io/author/turtlemonvh.html">
  <meta property="article:section" content="Articles"/>
  <meta property="article:tag" content="alexa"/>
  <meta property="article:tag" content="elasticbeanstalk"/>
  <meta property="article:tag" content="aws"/>
  <meta property="article:tag" content="biblescholar"/>
  <meta property="og:image" content="//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120">

  <title>Systems Doing &ndash; Basic vs Enhanced Health Checks on AWS ELB</title>


</head>
<body class="light-theme">

<aside>
  <div>
    <a href="https://turtlemonvh.github.io/">
      <img src="//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120" alt="Systems Doing" title="Systems Doing">
    </a>

    <h1>
      <a href="https://turtlemonvh.github.io/">Systems Doing</a>
    </h1>

    <p>Looking for beauty in the complex and the simple.</p>


    <nav>
      <ul class="list">


            <li>
              <a target="_self"
                 href="https://turtlemonvh.github.io/pages/home.html">
                Home
              </a>
            </li>
            <li>
              <a target="_self"
                 href="https://turtlemonvh.github.io/pages/projects.html">
                Projects
              </a>
            </li>

          <li>
            <a target="_self" href="https://about.me/turtlemonvh" >about.me</a>
          </li>
          <li>
            <a target="_self" href="https://www.dropbox.com/scl/fi/iqwp08l5mlb0gnv3kq5dm/TVH-Resume-2023-09-09.pdf?rlkey=4ixwskt3m9f4ceqcnnes2hrfn&raw=1" >resume</a>
          </li>
          <li>
            <a target="_self" href="http://turtle-philosophy.blogspot.com/" >old blog</a>
          </li>
      </ul>
    </nav>

    <ul class="social">
      <li>
        <a class="sc-twitter"
           href="https://twitter.com/turtlemonvh"
           target="_blank">
          <i class="fa-brands fa-twitter"></i>
        </a>
      </li>
      <li>
        <a class="sc-github"
           href="https://github.com/turtlemonvh"
           target="_blank">
          <i class="fa-brands fa-github"></i>
        </a>
      </li>
      <li>
        <a class="sc-linkedin"
           href="https://www.linkedin.com/in/vanheetm"
           target="_blank">
          <i class="fa-brands fa-linkedin"></i>
        </a>
      </li>
      <li>
        <a class="sc-bitbucket"
           href="https://bitbucket.org/turtlemonvh/"
           target="_blank">
          <i class="fa-brands fa-bitbucket"></i>
        </a>
      </li>
      <li>
        <a class="sc-stack-overflow"
           href="http://stackoverflow.com/users/790075/turtlemonvh"
           target="_blank">
          <i class="fa-brands fa-stack-overflow"></i>
        </a>
      </li>
    </ul>
  </div>

</aside>
  <main>


<article class="single">
  <header>
      
    <h1 id="basic-vs-enhanced-health-checks-on-aws-elb">Basic vs Enhanced Health Checks on AWS ELB</h1>
    <p>
      Posted on Thu 29 June 2017 in <a href="https://turtlemonvh.github.io/category/articles.html">Articles</a>

    </p>
  </header>


  <div>
    <h1>The Problem</h1>
<p>Yesterday I started getting a lot of emails from Amazon saying that there were issues with the ELB application that runs my Alexa App.</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">Something fishy with <a href="https://twitter.com/hashtag/ELB?src=hash">#ELB</a> on <a href="https://twitter.com/awscloud">@awscloud</a> over the last 24 hours... (no changes to application and load is stable and low) <a href="https://t.co/1wo2GupypW">pic.twitter.com/1wo2GupypW</a></p>&mdash; Timothy Van Heest (@turtlemonvh) <a href="https://twitter.com/turtlemonvh/status/880210227316088833">June 28, 2017</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>

<h1>Investigation</h1>
<p>I dug into this a bit more this morning.  Assuming you deploy your ELB application in a pretty standard configuration AWS allows you to download application logs.  This is what it looks like on the ELB download page.</p>
<p><img src="/images/20170628-elb-logs-download.png" alt="Downloading Logs from ELB Dashboard" style="width: 100%; display: block; margin: 0 auto; border: 1px solid; padding: 3px;"/></p>
<p>Because I wanted to check the logs over the course of a few days, I opted for "Full Logs".  What you get from this is a zip file of logs.  When you extract the contents, it will look something like this:</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code>is-mbp-timothy:tmp<span class="w"> </span>timothy$<span class="w"> </span>tree<span class="w"> </span>var/
var/
└──<span class="w"> </span>log
<span class="w">    </span>├──<span class="w"> </span>cfn-hup.log
<span class="w">    </span>├──<span class="w"> </span>cfn-hup.log.1
<span class="w">    </span>├──<span class="w"> </span>cfn-hup.log.2
<span class="w">    </span>├──<span class="w"> </span>cfn-init-cmd.log
<span class="w">    </span>├──<span class="w"> </span>cfn-init.log
<span class="w">    </span>├──<span class="w"> </span>cloud-init-output.log
<span class="w">    </span>├──<span class="w"> </span>cloud-init.log
<span class="w">    </span>├──<span class="w"> </span>cron
<span class="w">    </span>├──<span class="w"> </span>docker
<span class="w">    </span>├──<span class="w"> </span>docker-events.log
<span class="w">    </span>├──<span class="w"> </span>docker-ps.log
<span class="w">    </span>├──<span class="w"> </span>eb-activity.log
<span class="w">    </span>├──<span class="w"> </span>eb-cfn-init-call.log
<span class="w">    </span>├──<span class="w"> </span>eb-cfn-init.log
<span class="w">    </span>├──<span class="w"> </span>eb-commandprocessor.log
<span class="w">    </span>├──<span class="w"> </span>eb-docker
<span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span>containers
<span class="w">    </span>│<span class="w">       </span>└──<span class="w"> </span>eb-current-app
<span class="w">    </span>│<span class="w">           </span>├──<span class="w"> </span>2402dd479388-stdouterr.log
<span class="w">    </span>│<span class="w">           </span>└──<span class="w"> </span>rotated
<span class="w">    </span>│<span class="w">               </span>├──<span class="w"> </span>2402dd479388-stdouterr.log1497387661.gz
<span class="w">    </span>│<span class="w">               </span>├──<span class="w"> </span>2402dd479388-stdouterr.log1497690061.gz
<span class="w">    </span>│<span class="w">               </span>├──<span class="w"> </span>2402dd479388-stdouterr.log1497992461.gz
<span class="w">    </span>│<span class="w">               </span>├──<span class="w"> </span>2402dd479388-stdouterr.log1498298461.gz
<span class="w">    </span>│<span class="w">               </span>└──<span class="w"> </span>2402dd479388-stdouterr.log1498597261.gz
<span class="w">    </span>├──<span class="w"> </span>eb-publish-logs.log
<span class="w">    </span>├──<span class="w"> </span>eb-tools.log
<span class="w">    </span>├──<span class="w"> </span>healthd
<span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span>daemon.log
<span class="w">    </span>├──<span class="w"> </span>messages
<span class="w">    </span>├──<span class="w"> </span>nginx
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170620
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170621
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170622
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170623
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170624
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170625
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170626
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170627
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170627.err
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170628
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>access.log-20170629
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170620.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170621.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170622.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170623.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170624.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170625.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170626.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170627.gz
<span class="w">    </span>│<span class="w">   </span>├──<span class="w"> </span>error.log-20170628.gz
<span class="w">    </span>│<span class="w">   </span>└──<span class="w"> </span>error.log-20170629.gz
<span class="w">    </span>└──<span class="w"> </span>yum.log

<span class="m">7</span><span class="w"> </span>directories,<span class="w"> </span><span class="m">49</span><span class="w"> </span>files
</code></pre></div></td></tr></table></div>

<p>Because ELB was saying that my application was sick because of a lot of 4XX return codes, the first thing I checked was the access logs.  Here's what that looked like on the command line.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal"> 1</span>
<span class="normal"> 2</span>
<span class="normal"> 3</span>
<span class="normal"> 4</span>
<span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="c1"># Go into nginx log directory</span>
<span class="nb">cd</span><span class="w"> </span>var/log/nginx/

<span class="c1"># Extract extract logs for each day</span>
<span class="k">for</span><span class="w"> </span>f<span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="sb">`</span>ls<span class="w"> </span>access*.gz<span class="sb">`</span><span class="p">;</span><span class="w"> </span><span class="k">do</span><span class="w"> </span>gunzip<span class="w"> </span><span class="nv">$f</span><span class="p">;</span><span class="w"> </span><span class="k">done</span>

<span class="c1"># NOTE: It&#39;s not shown here, but the first thing I did was open the file in vim and poke around to get a feel for the structure of the log lines</span>

<span class="c1"># Check 1 day where there were a lot of issues (transitions from OK to SEVERE) for non-200 responses from the health check</span>
<span class="c1"># Didn&#39;t get anything</span>
cat<span class="w"> </span>access.log-20170627<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span><span class="s2">&quot;ELB-HealthChecker&quot;</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="m">200</span>

<span class="c1"># Get anything that is not explicitly a 200</span>
<span class="c1"># This showed me just 404s</span>
<span class="c1"># Note that if the string &quot;200&quot; showed up somewhere else in the log line aside from the status code slot this could be misleading, but this is unlikely to be common enough to be a big deal</span>
cat<span class="w"> </span>access.log-20170627<span class="w"> </span><span class="p">|</span><span class="w"> </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="m">200</span>
</code></pre></div></td></tr></table></div>

<p>Here is a sample of some log lines that were resulting in 404s.</p>
<div class="highlight"><pre><span></span><code><span class="mf">172.31.22.184</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">05</span><span class="p">:</span><span class="mf">19</span><span class="p">:</span><span class="mf">35</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /a2billing/customer/templates/default/footer.tpl HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;python-requests/2.6.0 CPython/2.6.6 Linux/2.6.32-696.3.1.el6.x86_64&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">05</span><span class="p">:</span><span class="mf">59</span><span class="p">:</span><span class="mf">03</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /mysqladmin/scripts/setup.php HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;the beast&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">06</span><span class="p">:</span><span class="mf">59</span><span class="p">:</span><span class="mf">20</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /manager/html HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)&quot;</span>
<span class="mf">172.31.22.184</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">09</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">36</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;HEAD / HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">0</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;python-requests/2.8.1&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">13</span><span class="p">:</span><span class="mf">00</span><span class="p">:</span><span class="mf">20</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /manager/html HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (compatible; MSIE 10.0; Windows NT 6.2; WOW64; Trident/6.0)&quot;</span>
<span class="mf">172.31.22.184</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">15</span><span class="p">:</span><span class="mf">29</span><span class="p">:</span><span class="mf">04</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /blog/the-7-funniest-k-pop-covers-from-mnets-i-can-see-your-voice/2311 HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;http://m.facebook.com/&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (Linux; Android 6.0.1; HTC Desire 826 dual sim Build/MMB29M; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/58.0.3029.83 Mobile Safari/537.36 [FB_IAB/FB4A;FBAV/129.0.0.29.67;]&quot;</span>
<span class="mf">172.31.22.184</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">16</span><span class="p">:</span><span class="mf">02</span><span class="p">:</span><span class="mf">02</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /blog/the-7-funniest-k-pop-covers-from-mnets-i-can-see-your-voice/2311 HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;http://m.facebook.com/&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (Linux; Android 5.1; A1601 Build/LMY47I; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/58.0.3029.83 Mobile Safari/537.36 [FB_IAB/FB4A;FBAV/129.0.0.29.67;]&quot;</span>
<span class="mf">172.31.22.184</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">21</span><span class="p">:</span><span class="mf">00</span><span class="p">:</span><span class="mf">49</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /testproxy.php HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (Windows NT 5.1; rv:32.0) Gecko/20100101 Firefox/31.0&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">20</span><span class="p">:</span><span class="mf">04</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /testproxy.php HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (Windows NT 5.1; rv:32.0) Gecko/20100101 Firefox/31.0&quot;</span>
<span class="mf">172.31.22.184</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">26</span><span class="p">:</span><span class="mf">12</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /blog/the-7-funniest-k-pop-covers-from-mnets-i-can-see-your-voice/2311 HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;http://m.facebook.com/&quot;</span><span class="w"> </span><span class="s">&quot;Mozilla/5.0 (Linux; Android 6.0.1; SM-G935F Build/MMB29K; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/58.0.3029.83 Mobile Safari/537.36 [FB_IAB/FB4A;FBAV/129.0.0.29.67;]&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">53</span><span class="p">:</span><span class="mf">06</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /muieblackcat HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;-&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">53</span><span class="p">:</span><span class="mf">06</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /phpMyAdmin/scripts/setup.php HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;-&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">53</span><span class="p">:</span><span class="mf">06</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /phpmyadmin/scripts/setup.php HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;-&quot;</span>
<span class="mf">172.31.31.21</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">[</span><span class="mf">26</span><span class="o">/</span><span class="n">Jun</span><span class="o">/</span><span class="mf">2017</span><span class="p">:</span><span class="mf">22</span><span class="p">:</span><span class="mf">53</span><span class="p">:</span><span class="mf">06</span><span class="w"> </span><span class="o">+</span><span class="mf">0000</span><span class="err">]</span><span class="w"> </span><span class="s">&quot;GET /pma/scripts/setup.php HTTP/1.1&quot;</span><span class="w"> </span><span class="mf">404</span><span class="w"> </span><span class="mf">18</span><span class="w"> </span><span class="s">&quot;-&quot;</span><span class="w"> </span><span class="s">&quot;-&quot;</span>
</code></pre></div>

<p>If you've run a public facing internet application before (or even an internal application at a company that does regular vulnerability scans) you will recognize this type of output.  These are automated tools probing the website for common vulnerabilities.  Those blog requests are likely to be due to an old site that was hosted at the same public ip as my application.  So the application is doing exactly what it is supposed to be doing when it returns a 404 for these requests.  The problem is that ELB is categorizing <em>any</em> 4XX response as a possible failure in the application.</p>
<p>This is burried a little bit in the documentation, but if you check out <a href="http://docs.aws.amazon.com/elasticbeanstalk/latest/dg/health-enhanced.html#health-enhanced-factors">the docs on enhanced health checks</a> that section does state the following about how it uses HTTP requests to determine health.</p>
<blockquote>
<p>When no operation is in progress on an environment, the primary source of information about instance and environment health is the web server logs for each instance. To determine the health of an instance and the overall health of the environment, Elastic Beanstalk considers the number of requests, the result of each request, and the speed at which each request was resolved.</p>
</blockquote>
<h1>Solution</h1>
<p>To fix this, I went to the "Configuration &gt; Health" page on the ELB dashboard and changed the section on "Health Reporting" to use "Basic" health checks instead of "Enhanced".  This triggered a restart of the ELB application.</p>
<p>Once that restart finished, I ran this simple curl script for a few minutes to send a bunch of requests to the application that would trigger 404s.</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span class="normal">1</span>
<span class="normal">2</span>
<span class="normal">3</span>
<span class="normal">4</span>
<span class="normal">5</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">while</span><span class="w"> </span>true<span class="p">;</span><span class="w"> </span><span class="k">do</span>
<span class="w">    </span>curl<span class="w"> </span>-X<span class="w"> </span>GET<span class="w"> </span><span class="s1">&#39;https://www.biblescholarsearch.net/index.action&#39;</span><span class="p">;</span>
<span class="w">    </span>sleep<span class="w"> </span><span class="m">1</span><span class="p">;</span>
<span class="w">    </span><span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">;</span>
<span class="k">done</span>
</code></pre></div></td></tr></table></div>

<p>Then I checked the ELB dashboard to confirm that even with all these requests coming in, the application health was still reporting as 'OK'.  Everything looked fine.</p>
<p>With that updated, hopefully I'll be getting less monitoring emails!</p>
<h1>Summary</h1>
<p>The enhanced health feature of ELB is pretty neat.  It provides a lot of nice metrics, and can detect some pretty common failure conditions.</p>
<p>However, it is very fragile since it considers a large number of 4XX errors to be an indicator of problems in the application.  Since <a href="https://en.wikipedia.org/wiki/List_of_HTTP_status_codes#4xx_Client_errors">4XX errors are supposed to indicate client errors</a> (not server errors), this is not a great default configuration.  Ideally, the application would be considered unhealthy when lots of 5XX errors are returned, but still healthy when 4XX errors are returned.</p>
<p>In addition to just be annoying, this means that every ELB application out there that uses "Enhanced Health Checks" may be prone to a trivial <a href="https://en.wikipedia.org/wiki/Denial-of-service_attack">availability attack</a>.  All you need to do is send a large number of requests to urls the application doesn't understand (i.e. that return 404s), and ELB will start marking app instances as unhealthy and quickly trying to cycle the pool of application instances to get into a healthy state.  I <em>think</em> that ELB will still keep a minimum number of application instances available while it does this (so the site won't go down), but it could get expensive and kind of annoying.</p>
<p>So even though "Enhanced Health Checks" are cool, I don't think I'm ever going to use them again.  It's simpler and safer to set up a custom health check endpoint that accurately reflects the health o your application.</p>
<blockquote>
<p>UPDDATE (10 am EST 2017/06/29)</p>
</blockquote>
<p>Unsurprisingly, it looks like I'm not the first one to run into this.</p>
<ul>
<li><a href="https://forums.aws.amazon.com/thread.jspa?messageID=695637&#695637;">https://forums.aws.amazon.com/thread.jspa?messageID=695637&#695637;</a><ul>
<li>Forum post pointing out the problem with marking app as sick when you get lots of 4XX responses</li>
<li>One user points out that lots of 4XX can at the very least block a deployment from succeeding</li>
</ul>
</li>
<li><a href="https://stackoverflow.com/questions/36398456/elastic-beanstalk-disable-health-state-change-based-on-4xx-responses">https://stackoverflow.com/questions/36398456/elastic-beanstalk-disable-health-state-change-based-on-4xx-responses</a><ul>
<li>stackoverflow post asking for information about the configurability of "Enhanced Health Checks"</li>
<li>contains an "interesting" hack to rewrite a monitoring script used by AWS to monitor the logs and determine health state</li>
</ul>
</li>
</ul>
<p>Also, the comments on the blog don't seem to be working right now and I don't have time to fix that right now, so until those are back, I recommend commenting on one of those posts or reaching out to me on twitter by responding to the following tweet.</p>
<blockquote class="twitter-tweet" data-lang="en"><p lang="en" dir="ltr">This behavior was surprising enough that I took time to write about it:<a href="https://t.co/bvKkf3kOaK">https://t.co/bvKkf3kOaK</a><br>tldr: beware <a href="https://twitter.com/hashtag/ELB?src=hash">#ELB</a> &quot;enhanced health checks&quot;</p>&mdash; Timothy Van Heest (@turtlemonvh) <a href="https://twitter.com/turtlemonvh/status/880419389224484864">June 29, 2017</a></blockquote>
<script async src="//platform.twitter.com/widgets.js" charset="utf-8"></script>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="https://turtlemonvh.github.io/tag/alexa.html">alexa</a>
      <a href="https://turtlemonvh.github.io/tag/elasticbeanstalk.html">elasticbeanstalk</a>
      <a href="https://turtlemonvh.github.io/tag/aws.html">aws</a>
      <a href="https://turtlemonvh.github.io/tag/biblescholar.html">biblescholar</a>
    </p>
  </div>






<!-- Disqus -->
<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'turtlemonvh-github-io';
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>
    Please enable JavaScript to view comments.
</noscript>
<!-- End Disqus -->
</article>

<footer>
<p>&copy;  </p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
</p></footer>  </main>

<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " Systems Doing ",
  "url" : "https://turtlemonvh.github.io",
  "image": "//s.gravatar.com/avatar/fdb8ce54c398b1aa794833a601507361?s=120",
  "description": "Thoughts and writings"
}
</script>
</body>
</html>